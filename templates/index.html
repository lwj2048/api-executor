<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .code-editor {
            font-family: 'Monaco', 'Consolas', monospace;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .stats-card {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
        }
        .action-buttons {
            min-width: 120px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg gradient-bg text-white">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#">
                <i class="bi bi-code-square me-2"></i>{{ app_name }}
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-link text-white">
                    <i class="bi bi-person-circle me-1"></i>{{ current_user.username }}
                </span>
                <a class="nav-link text-white" href="#" onclick="loadStats()">
                    <i class="bi bi-bar-chart-line me-1"></i>统计
                </a>
                <a class="nav-link text-white" href="#" onclick="loadExecutions()">
                    <i class="bi bi-clock-history me-1"></i>执行历史
                </a>
                <a class="nav-link text-white" href="#" onclick="logout()" title="登出">
                    <i class="bi bi-box-arrow-right me-1"></i>登出
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 左侧面板 - 创建API -->
            <div class="col-md-4">
                <div class="card card-hover">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>创建新API</h5>
                    </div>
                    <div class="card-body">
                        <form id="createApiForm">
                            <div class="mb-3">
                                <label class="form-label">API名称</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" name="description" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">端点路径</label>
                                <input type="text" class="form-control" name="endpoint_path" placeholder="/my-api" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">操作类型</label>
                                <select class="form-select" name="action_type" required onchange="updateActionExample()">
                                    <option value="">选择操作类型</option>
                                    <option value="shell">Shell命令</option>
                                    <option value="http">HTTP请求</option>
                                    <option value="python">Python代码</option>
                                    <option value="webhook">Webhook调用</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">操作内容</label>
                                <textarea class="form-control code-editor" name="action_content" rows="6" required></textarea>
                                <div class="form-text" id="actionExample"></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">参数定义 (JSON格式)</label>
                                <textarea class="form-control code-editor" name="parameters" rows="3" placeholder='{"param1": "参数1描述", "param2": "参数2描述"}'></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableLogging" name="enable_logging" checked>
                                    <label class="form-check-label" for="enableLogging">
                                        <i class="bi bi-journal-text me-1"></i>
                                        启用日志记录
                                    </label>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    禁用后API执行不会保存到数据库，适合频繁调用的API
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-check-circle me-2"></i>创建API
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 系统统计 -->
                <div class="card card-hover mt-4">
                    <div class="card-header stats-card text-white">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>系统统计</h5>
                    </div>
                    <div class="card-body" id="statsContent">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧面板 - API列表 -->
            <div class="col-md-8">
                <div class="card card-hover">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>API列表</h5>
                        <button class="btn btn-light btn-sm" onclick="loadApis()">
                            <i class="bi bi-arrow-clockwise me-1"></i>刷新
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="apiList">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 执行历史 -->
                <div class="card card-hover mt-4" id="executionHistoryCard" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>执行历史</h5>
                    </div>
                    <div class="card-body">
                        <div id="executionHistory">
                            <!-- 执行历史内容 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 - 显示API密钥 -->
    <div class="modal fade" id="apiKeyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-key me-2"></i>API密钥信息</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <h6>您的API密钥:</h6>
                        <code id="generatedApiKey" class="fs-6"></code>
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="copyApiKey()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <div class="alert alert-info">
                        <h6>使用方法:</h6>
                        <code id="usageExample"></code>
                    </div>
                    <small class="text-muted">请妥善保存此密钥，系统不会再次显示。</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 - 编辑API -->
    <div class="modal fade" id="editApiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>编辑API定义</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editApiForm">
                        <input type="hidden" id="editApiId" name="apiId">
                        <div class="mb-3">
                            <label class="form-label">API名称</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" id="editDescription" name="description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">端点路径</label>
                            <input type="text" class="form-control" id="editEndpointPath" name="endpoint_path" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">操作类型</label>
                            <select class="form-select" id="editActionType" name="action_type" required onchange="updateEditActionExample()">
                                <option value="shell">Shell命令</option>
                                <option value="http">HTTP请求</option>
                                <option value="python">Python代码</option>
                                <option value="webhook">Webhook调用</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">操作内容</label>
                            <textarea class="form-control code-editor" id="editActionContent" name="action_content" rows="6" required></textarea>
                            <div class="form-text" id="editActionExample"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">参数定义 (JSON格式)</label>
                            <textarea class="form-control code-editor" id="editParameters" name="parameters" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editEnableLogging" name="enable_logging">
                                <label class="form-check-label" for="editEnableLogging">
                                    <i class="bi bi-journal-text me-1"></i>
                                    启用日志记录
                                </label>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                禁用后API执行不会保存到数据库，适合频繁调用的API
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="saveApiEdit()">
                        <i class="bi bi-check-circle me-2"></i>保存修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 - API执行日志 -->
    <div class="modal fade" id="apiLogsModal" tabindex="-1">
                                <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-journal-text me-2"></i>API执行日志</h5>
                    <div>
                        <button type="button" class="btn btn-danger btn-sm me-2" onclick="clearApiLogs()" id="clearLogsBtn" style="display: none;">
                            <i class="bi bi-trash me-1"></i>清空日志
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="apiLogsContent">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadApis();
            loadStats();
            
            // 每5分钟检查一次会话状态
            setInterval(checkSessionStatus, 5 * 60 * 1000);
        });

        // 检查会话状态
        async function checkSessionStatus() {
            try {
                const response = await fetch('/api/session');
                if (response.status === 401) {
                    alert('会话已过期，请重新登录');
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('检查会话状态失败:', error);
            }
        }

        // 全局错误处理
        async function handleApiResponse(response) {
            if (response.status === 401) {
                alert('会话已过期，请重新登录');
                window.location.href = '/login';
                return null;
            }
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: '未知错误' }));
                throw new Error(error.detail || error.message || '请求失败');
            }
            
            return response.json();
        }

        // 操作类型示例
        const actionExamples = {
            shell: 'echo "Hello {name}!"\nls -la\nping -c 3 {host}',
            http: JSON.stringify({
                url: "https://api.example.com/data",
                method: "POST",
                headers: {"Content-Type": "application/json"},
                data: {"message": "Hello from {name}"}
            }, null, 2),
            python: 'print(f"Hello {name}!")\nimport requests\nresponse = requests.get("https://api.github.com/users/{username}")\nprint(response.json())',
            webhook: JSON.stringify({
                url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL",
                payload: {"text": "任务完成: {task_name}"},
                headers: {"Content-Type": "application/json"}
            }, null, 2)
        };

        function updateActionExample() {
            const actionType = document.querySelector('select[name="action_type"]').value;
            const exampleDiv = document.getElementById('actionExample');
            const contentTextarea = document.querySelector('textarea[name="action_content"]');
            
            if (actionType && actionExamples[actionType]) {
                exampleDiv.innerHTML = `<strong>示例:</strong><br><code>${actionExamples[actionType].replace(/\n/g, '<br>')}</code>`;
                if (!contentTextarea.value.trim()) {
                    contentTextarea.value = actionExamples[actionType];
                }
            } else {
                exampleDiv.innerHTML = '';
            }
        }

        // 加载API列表
        async function loadApis() {
            try {
                const response = await fetch('/api/definitions');
                const apis = await response.json();
                
                const listElement = document.getElementById('apiList');
                
                if (apis.length === 0) {
                    listElement.innerHTML = '<div class="text-center text-muted"><i class="bi bi-inbox fs-1"></i><br>暂无API定义</div>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-dark"><tr><th>名称</th><th>路径</th><th>类型</th><th>状态</th><th>日志</th><th>执行次数</th><th>操作</th></tr></thead><tbody>';
                
                apis.forEach(api => {
                    const statusBadge = api.is_active 
                        ? '<span class="badge bg-success status-badge">启用</span>'
                        : '<span class="badge bg-danger status-badge">禁用</span>';
                    
                    const loggingBadge = api.enable_logging 
                        ? '<span class="badge bg-info">记录</span>'
                        : '<span class="badge bg-secondary">禁用</span>';
                    
                    html += `
                        <tr>
                            <td><strong>${api.name}</strong><br><small class="text-muted">${api.description}</small></td>
                            <td><code>${api.endpoint_path}</code></td>
                            <td><span class="badge bg-info">${api.action_type}</span></td>
                            <td>${statusBadge}</td>
                            <td>${loggingBadge}</td>
                            <td><span class="badge bg-secondary">${api.execution_count}</span></td>
                            <td class="action-buttons">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info" onclick="viewApiLogs(${api.id})" title="查看日志" ${!api.enable_logging ? 'disabled' : ''}>
                                        <i class="bi bi-journal-text"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showApiKey('${api.api_key}', '${api.endpoint_path}')" title="查看密钥">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="editApi(${api.id})" title="编辑">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm ${api.enable_logging ? 'btn-outline-warning' : 'btn-outline-success'}" onclick="toggleLogging(${api.id})" title="${api.enable_logging ? '禁用日志' : '启用日志'}">
                                        <i class="bi bi-${api.enable_logging ? 'journal-x' : 'journal-check'}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="toggleApi(${api.id})" title="${api.is_active ? '禁用' : '启用'}">
                                        <i class="bi bi-toggle-${api.is_active ? 'on' : 'off'}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteApi(${api.id})" title="删除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                listElement.innerHTML = html;
                
            } catch (error) {
                document.getElementById('apiList').innerHTML = '<div class="alert alert-danger">加载失败: ' + error.message + '</div>';
            }
        }

        // 创建API
        document.getElementById('createApiForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/api/definitions', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 显示API密钥
                    document.getElementById('generatedApiKey').textContent = result.api_key;
                    document.getElementById('usageExample').textContent = 
                        `curl "${window.location.origin}/execute?key=${result.api_key}&param1=value1"`;
                    
                    new bootstrap.Modal(document.getElementById('apiKeyModal')).show();
                    
                    // 重置表单并刷新列表
                    this.reset();
                    document.getElementById('actionExample').innerHTML = '';
                    loadApis();
                    loadStats();
                } else {
                    alert('创建失败: ' + (result.detail || result.message));
                }
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        });

        // 复制API密钥
        function copyApiKey() {
            const apiKey = document.getElementById('generatedApiKey').textContent;
            navigator.clipboard.writeText(apiKey).then(() => {
                alert('API密钥已复制到剪贴板');
            });
        }

        // 显示API密钥
        function showApiKey(apiKey, endpoint) {
            document.getElementById('generatedApiKey').textContent = apiKey;
            document.getElementById('usageExample').textContent = 
                `curl "${window.location.origin}/execute?key=${apiKey}&param1=value1"`;
            new bootstrap.Modal(document.getElementById('apiKeyModal')).show();
        }

        // 切换API状态
        async function toggleApi(id) {
            try {
                const response = await fetch(`/api/definitions/${id}/toggle`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    loadApis();
                    loadStats();
                } else {
                    alert('操作失败');
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 删除API
        async function deleteApi(id) {
            if (!confirm('确定要删除这个API定义吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/definitions/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadApis();
                    loadStats();
                } else {
                    alert('删除失败');
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 加载统计信息
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const html = `
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">${stats.total_apis}</h4>
                            <small>总API数</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">${stats.active_apis}</h4>
                            <small>启用中</small>
                        </div>
                        <div class="col-6 mt-3">
                            <h4 class="text-info">${stats.total_executions}</h4>
                            <small>总执行次数</small>
                        </div>
                        <div class="col-6 mt-3">
                            <h4 class="text-warning">${stats.success_rate}%</h4>
                            <small>成功率</small>
                        </div>
                    </div>
                `;
                
                document.getElementById('statsContent').innerHTML = html;
            } catch (error) {
                document.getElementById('statsContent').innerHTML = '<div class="text-danger">加载失败</div>';
            }
        }

        // 编辑API
        async function editApi(id) {
            try {
                const response = await fetch(`/api/definitions/${id}`);
                if (!response.ok) {
                    throw new Error('获取API信息失败');
                }
                
                const api = await response.json();
                
                // 填充编辑表单
                document.getElementById('editApiId').value = api.id;
                document.getElementById('editName').value = api.name;
                document.getElementById('editDescription').value = api.description;
                document.getElementById('editEndpointPath').value = api.endpoint_path;
                document.getElementById('editActionType').value = api.action_type;
                document.getElementById('editActionContent').value = api.action_content;
                document.getElementById('editParameters').value = JSON.stringify(api.parameters, null, 2);
                document.getElementById('editEnableLogging').checked = api.enable_logging;
                
                // 更新示例
                updateEditActionExample();
                
                // 显示模态框
                new bootstrap.Modal(document.getElementById('editApiModal')).show();
                
            } catch (error) {
                alert('获取API信息失败: ' + error.message);
            }
        }

        // 保存API编辑
        async function saveApiEdit() {
            const id = document.getElementById('editApiId').value;
            const formData = new FormData();
            
            formData.append('name', document.getElementById('editName').value);
            formData.append('description', document.getElementById('editDescription').value);
            formData.append('endpoint_path', document.getElementById('editEndpointPath').value);
            formData.append('action_type', document.getElementById('editActionType').value);
            formData.append('action_content', document.getElementById('editActionContent').value);
            formData.append('parameters', document.getElementById('editParameters').value);
            formData.append('enable_logging', document.getElementById('editEnableLogging').checked);
            
            try {
                const response = await fetch(`/api/definitions/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editApiModal')).hide();
                    loadApis();
                    alert('API更新成功');
                } else {
                    alert('更新失败: ' + (result.detail || result.message));
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
            }
        }

        // 切换日志记录状态
        async function toggleLogging(id) {
            try {
                const response = await fetch(`/api/definitions/${id}/toggle-logging`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadApis();
                    alert(result.message);
                } else {
                    alert('操作失败: ' + (result.detail || result.message));
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 更新编辑操作示例
        function updateEditActionExample() {
            const actionType = document.getElementById('editActionType').value;
            const exampleDiv = document.getElementById('editActionExample');
            const contentTextarea = document.getElementById('editActionContent');
            
            if (actionType && actionExamples[actionType]) {
                exampleDiv.innerHTML = `<strong>示例:</strong><br><code>${actionExamples[actionType].replace(/\n/g, '<br>')}</code>`;
            } else {
                exampleDiv.innerHTML = '';
            }
        }

        // 查看API执行日志
        let currentApiId = null; // 全局变量保存当前查看的API ID
        
        async function viewApiLogs(id) {
            currentApiId = id; // 保存API ID用于删除操作
            
            try {
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('apiLogsModal'));
                modal.show();
                
                // 加载日志数据
                const response = await fetch(`/api/definitions/${id}/logs?limit=50`);
                if (!response.ok) {
                    throw new Error('获取日志失败');
                }
                
                const data = await response.json();
                const content = document.getElementById('apiLogsContent');
                const clearBtn = document.getElementById('clearLogsBtn');
                
                if (data.logs.length === 0) {
                    clearBtn.style.display = 'none';
                    content.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="bi bi-inbox fs-1"></i><br>
                            <h5>${data.api_info.name}</h5>
                            <p>暂无执行记录</p>
                        </div>
                    `;
                } else {
                    clearBtn.style.display = 'inline-block';
                    let html = `
                        <div class="mb-3">
                            <h6><i class="bi bi-info-circle me-2"></i>API信息</h6>
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <strong>${data.api_info.name}</strong> - ${data.api_info.description}<br>
                                    <small class="text-muted">端点: <code>${data.api_info.endpoint_path}</code></small>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>执行时间</th>
                                        <th>来源IP</th>
                                        <th>参数</th>
                                        <th>状态</th>
                                        <th>耗时</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.logs.forEach(log => {
                        const statusBadge = log.status === 'success' 
                            ? '<span class="badge bg-success">成功</span>'
                            : '<span class="badge bg-danger">失败</span>';
                        
                        const params = Object.keys(log.parameters).length > 0 
                            ? JSON.stringify(log.parameters)
                            : '无参数';
                        
                        const truncatedParams = params.length > 50 ? params.substring(0, 50) + '...' : params;
                        
                        html += `
                            <tr>
                                <td><small>${new Date(log.execution_time).toLocaleString()}</small></td>
                                <td><code>${log.request_ip || 'unknown'}</code></td>
                                <td><small title="${params}">${truncatedParams}</small></td>
                                <td>${statusBadge}</td>
                                <td><small>${log.duration_ms}ms</small></td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-info" onclick="showLogDetails(${log.id}, '${log.execution_time}', '${log.status}', '${log.duration_ms}', '${log.request_ip}', \`${JSON.stringify(log.parameters)}\`, \`${(log.result || '').replace(/`/g, '\\`')}\`, \`${(log.error_message || '').replace(/`/g, '\\`')}\`)" title="查看详情">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLog(${log.id})" title="删除记录">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    content.innerHTML = html;
                }
                
            } catch (error) {
                document.getElementById('apiLogsContent').innerHTML = 
                    `<div class="alert alert-danger">加载日志失败: ${error.message}</div>`;
            }
        }

        // 删除单个日志记录
        async function deleteLog(logId) {
            if (!confirm('确定要删除这条日志记录吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/executions/${logId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 重新加载日志
                    viewApiLogs(currentApiId);
                    alert('日志记录删除成功');
                } else {
                    alert('删除失败: ' + (result.detail || result.message));
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 清空API的所有日志
        async function clearApiLogs() {
            if (!confirm('确定要清空所有日志记录吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/definitions/${currentApiId}/logs`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 重新加载日志
                    viewApiLogs(currentApiId);
                    alert(result.message);
                } else {
                    alert('清空失败: ' + (result.detail || result.message));
                }
            } catch (error) {
                alert('清空失败: ' + error.message);
            }
        }

        // 显示日志详情
        function showLogDetails(id, time, status, duration, ip, params, result, error) {
            const paramsObj = JSON.parse(params);
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header ${status === 'success' ? 'bg-success' : 'bg-danger'} text-white">
                            <h5 class="modal-title">执行详情 #${id}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>执行时间:</strong><br>
                                    <small>${new Date(time).toLocaleString()}</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>耗时:</strong><br>
                                    <span class="badge bg-info">${duration}ms</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>来源IP:</strong><br>
                                    <code>${ip}</code>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>请求参数:</strong>
                                <pre class="bg-light p-2 rounded"><code>${JSON.stringify(paramsObj, null, 2)}</code></pre>
                            </div>
                            
                            ${error ? `
                                <div class="mb-3">
                                    <strong>错误信息:</strong>
                                    <div class="alert alert-danger">${error}</div>
                                </div>
                            ` : ''}
                            
                            <div class="mb-3">
                                <strong>执行结果:</strong>
                                <pre class="bg-light p-2 rounded" style="max-height: 300px; overflow-y: auto;"><code>${result}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // 登出
        async function logout() {
            if (confirm('确定要登出吗？')) {
                try {
                    const response = await fetch('/logout', { method: 'POST' });
                    if (response.ok) {
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('登出失败:', error);
                }
            }
        }

        // 加载执行历史
        async function loadExecutions() {
            try {
                const response = await fetch('/api/executions?limit=20');
                const executions = await response.json();
                
                const card = document.getElementById('executionHistoryCard');
                const content = document.getElementById('executionHistory');
                
                if (executions.length === 0) {
                    content.innerHTML = '<div class="text-center text-muted">暂无执行记录</div>';
                } else {
                    let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>时间</th><th>API密钥</th><th>来源IP</th><th>参数</th><th>状态</th><th>耗时</th></tr></thead><tbody>';
                    
                    executions.forEach(exec => {
                        const statusBadge = exec.status === 'success' 
                            ? '<span class="badge bg-success">成功</span>'
                            : '<span class="badge bg-danger">失败</span>';
                        
                        const params = Object.keys(exec.parameters).length > 0 
                            ? JSON.stringify(exec.parameters) 
                            : '无';
                        
                        html += `
                            <tr>
                                <td><small>${new Date(exec.execution_time).toLocaleString()}</small></td>
                                <td><code>${exec.api_key.substring(0, 8)}...</code></td>
                                <td><code>${exec.request_ip || 'unknown'}</code></td>
                                <td><small>${params}</small></td>
                                <td>${statusBadge}</td>
                                <td><small>${exec.duration_ms}ms</small></td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    content.innerHTML = html;
                }
                
                card.style.display = 'block';
            } catch (error) {
                console.error('加载执行历史失败:', error);
            }
        }
    </script>
</body>
</html> 