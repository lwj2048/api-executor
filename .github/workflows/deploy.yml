name: APIç®¡ç†ç³»ç»Ÿæµ‹è¯•ä¸éƒ¨ç½²

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  test:
    name: åŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: api_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ğŸ“¦ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“‹ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx pytest-asyncio

    - name: ğŸ—„ï¸ ç­‰å¾…æ•°æ®åº“å°±ç»ª
      run: |
        echo "ç­‰å¾…PostgreSQLå¯åŠ¨..."
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "âœ… PostgreSQLå·²å°±ç»ª"
            break
          fi
          echo "ç­‰å¾…ä¸­... ($i/30)"
          sleep 2
        done

    - name: ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "SUPABASE_URL=postgresql://postgres:testpass123@localhost:5432/api_test" >> $GITHUB_ENV
        echo "SECRET_KEY=test-secret-key-for-github-actions-very-long-and-secure" >> $GITHUB_ENV
        echo "ADMIN_USERNAME=admin" >> $GITHUB_ENV
        echo "ADMIN_PASSWORD=admin123" >> $GITHUB_ENV
        echo "DEBUG=true" >> $GITHUB_ENV
        echo "HOST=127.0.0.1" >> $GITHUB_ENV
        echo "PORT=8080" >> $GITHUB_ENV

    - name: ğŸ—ï¸ åˆ›å»ºæµ‹è¯•è„šæœ¬
      run: |
        cat > test_api.py << 'EOF'
        import httpx
        import asyncio
        import json
        import time
        import sys
        from urllib.parse import urlencode

        async def test_api_system():
            """æµ‹è¯•APIç³»ç»Ÿçš„ä¸»è¦åŠŸèƒ½"""
            base_url = "http://127.0.0.1:8080"
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            print("ğŸ”„ ç­‰å¾…APIæœåŠ¡å¯åŠ¨...")
            for i in range(30):
                try:
                    async with httpx.AsyncClient(timeout=10) as client:
                        response = await client.get(f"{base_url}/health")
                        if response.status_code == 200:
                            print("âœ… APIæœåŠ¡å·²å¯åŠ¨")
                            break
                except:
                    pass
                await asyncio.sleep(2)
            else:
                print("âŒ APIæœåŠ¡å¯åŠ¨å¤±è´¥")
                return False

            async with httpx.AsyncClient(timeout=30) as client:
                # æµ‹è¯•1: å¥åº·æ£€æŸ¥
                print("\nğŸ¥ æµ‹è¯•å¥åº·æ£€æŸ¥...")
                response = await client.get(f"{base_url}/health")
                assert response.status_code == 200
                health_data = response.json()
                assert health_data["status"] == "ok"
                print("âœ… å¥åº·æ£€æŸ¥é€šè¿‡")

                # æµ‹è¯•2: è®¿é—®ç™»å½•é¡µé¢
                print("\nğŸ” æµ‹è¯•ç™»å½•é¡µé¢...")
                response = await client.get(f"{base_url}/login")
                assert response.status_code == 200
                print("âœ… ç™»å½•é¡µé¢è®¿é—®æ­£å¸¸")

                # æµ‹è¯•3: ç”¨æˆ·ç™»å½•
                print("\nğŸ‘¤ æµ‹è¯•ç”¨æˆ·ç™»å½•...")
                login_data = {
                    "username": "admin",
                    "password": "admin123"
                }
                response = await client.post(f"{base_url}/login", data=login_data)
                assert response.status_code == 200
                login_result = response.json()
                assert login_result["success"] is True
                
                # è·å–session cookie
                session_cookie = response.cookies.get("session_id")
                assert session_cookie is not None
                print("âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ")

                # è®¾ç½®è®¤è¯cookie
                client.cookies.set("session_id", session_cookie)

                # æµ‹è¯•4: è®¿é—®ä¸»é¡µ
                print("\nğŸ  æµ‹è¯•ä¸»é¡µè®¿é—®...")
                response = await client.get(f"{base_url}/")
                assert response.status_code == 200
                print("âœ… ä¸»é¡µè®¿é—®æ­£å¸¸")

                # æµ‹è¯•5: åˆ›å»ºAPIå®šä¹‰
                print("\nğŸ“ æµ‹è¯•åˆ›å»ºAPIå®šä¹‰...")
                api_data = {
                    "name": "æµ‹è¯•API",
                    "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•API",
                    "endpoint_path": "/test/hello",
                    "action_type": "shell",
                    "action_content": "echo 'Hello from API Test'",
                    "parameters": "{}",
                    "enable_logging": "true"
                }
                response = await client.post(f"{base_url}/api/definitions", data=api_data)
                assert response.status_code == 200
                create_result = response.json()
                assert create_result["success"] is True
                api_key = create_result["api_key"]
                print(f"âœ… APIå®šä¹‰åˆ›å»ºæˆåŠŸï¼ŒAPI Key: {api_key[:10]}...")

                # æµ‹è¯•6: è·å–APIå®šä¹‰åˆ—è¡¨
                print("\nğŸ“‹ æµ‹è¯•è·å–APIå®šä¹‰åˆ—è¡¨...")
                response = await client.get(f"{base_url}/api/definitions")
                assert response.status_code == 200
                api_list = response.json()
                assert len(api_list) > 0
                assert api_list[0]["name"] == "æµ‹è¯•API"
                print("âœ… APIå®šä¹‰åˆ—è¡¨è·å–æˆåŠŸ")

                # æµ‹è¯•7: æ‰§è¡ŒAPI
                print("\nğŸš€ æµ‹è¯•APIæ‰§è¡Œ...")
                response = await client.get(f"{base_url}/execute?key={api_key}")
                assert response.status_code == 200
                exec_result = response.json()
                assert exec_result["success"] is True
                assert "Hello from API Test" in exec_result["result"]
                print("âœ… APIæ‰§è¡ŒæˆåŠŸ")

                # æµ‹è¯•8: è·å–æ‰§è¡Œç»Ÿè®¡
                print("\nğŸ“Š æµ‹è¯•è·å–æ‰§è¡Œç»Ÿè®¡...")
                response = await client.get(f"{base_url}/api/stats")
                assert response.status_code == 200
                stats = response.json()
                assert stats["total_apis"] > 0
                assert stats["total_executions"] > 0
                print("âœ… æ‰§è¡Œç»Ÿè®¡è·å–æˆåŠŸ")

                print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
                return True

        if __name__ == "__main__":
            try:
                result = asyncio.run(test_api_system())
                if result:
                    print("\nâœ… APIç³»ç»Ÿæµ‹è¯•å®Œæˆ - æ‰€æœ‰åŠŸèƒ½æ­£å¸¸")
                    sys.exit(0)
                else:
                    print("\nâŒ APIç³»ç»Ÿæµ‹è¯•å¤±è´¥")
                    sys.exit(1)
            except Exception as e:
                print(f"\nâŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
                sys.exit(1)
        EOF

    - name: ğŸƒ å¯åŠ¨APIæœåŠ¡
      run: |
        echo "ğŸš€ å¯åŠ¨APIæœåŠ¡..."
        python main.py --port 8080 --host 127.0.0.1 &
        API_PID=$!
        echo "API_PID=$API_PID" >> $GITHUB_ENV
        echo "âœ… APIæœåŠ¡å·²å¯åŠ¨ (PID: $API_PID)"

    - name: ğŸ§ª è¿è¡ŒåŠŸèƒ½æµ‹è¯•
      run: |
        echo "ğŸ§ª å¼€å§‹è¿è¡ŒåŠŸèƒ½æµ‹è¯•..."
        python test_api.py

    - name: ğŸ›‘ åœæ­¢APIæœåŠ¡
      if: always()
      run: |
        if [ ! -z "$API_PID" ]; then
          echo "ğŸ›‘ åœæ­¢APIæœåŠ¡ (PID: $API_PID)"
          kill $API_PID || true
        fi

  docker-test:
    name: Dockeræµ‹è¯•
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¦ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ³ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ æ„å»ºDockeré•œåƒ
      run: |
        echo "ğŸ—ï¸ æ„å»ºDockeré•œåƒ..."
        docker build -t api-management-test:latest .
        echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

    - name: ğŸ—„ï¸ å¯åŠ¨PostgreSQLå®¹å™¨
      run: |
        echo "ğŸ—„ï¸ å¯åŠ¨PostgreSQLå®¹å™¨..."
        docker run -d \
          --name postgres-test \
          -e POSTGRES_DB=api_test \
          -e POSTGRES_USER=postgres \
          -e POSTGRES_PASSWORD=testpass123 \
          -p 5432:5432 \
          postgres:14
        
        echo "â³ ç­‰å¾…PostgreSQLå¯åŠ¨..."
        for i in {1..30}; do
          if docker exec postgres-test pg_isready -U postgres; then
            echo "âœ… PostgreSQLå·²å°±ç»ª"
            break
          fi
          echo "ç­‰å¾…ä¸­... ($i/30)"
          sleep 2
        done

    - name: ğŸš€ è¿è¡ŒAPIå®¹å™¨
      run: |
        echo "ğŸš€ å¯åŠ¨APIç®¡ç†ç³»ç»Ÿå®¹å™¨..."
        docker run -d \
          --name api-management-test \
          --link postgres-test:postgres \
          -p 8080:8080 \
          -e SUPABASE_URL="postgresql://postgres:testpass123@postgres:5432/api_test" \
          -e SECRET_KEY="test-secret-key-for-docker-test-very-long-and-secure" \
          -e ADMIN_USERNAME="admin" \
          -e ADMIN_PASSWORD="admin123" \
          -e DEBUG="true" \
          -e HOST="0.0.0.0" \
          -e PORT="8080" \
          api-management-test:latest
        
        echo "â³ ç­‰å¾…APIæœåŠ¡å¯åŠ¨..."
        for i in {1..60}; do
          if curl -f http://localhost:8080/health > /dev/null 2>&1; then
            echo "âœ… APIæœåŠ¡å·²å°±ç»ª"
            break
          fi
          echo "ç­‰å¾…ä¸­... ($i/60)"
          sleep 2
        done

    - name: ğŸ§ª æµ‹è¯•Dockeréƒ¨ç½²
      run: |
        echo "ğŸ§ª æµ‹è¯•Dockeréƒ¨ç½²çš„APIåŠŸèƒ½..."
        
        # æµ‹è¯•å¥åº·æ£€æŸ¥
        echo "ğŸ¥ æµ‹è¯•å¥åº·æ£€æŸ¥..."
        response=$(curl -s http://localhost:8080/health)
        echo "å¥åº·æ£€æŸ¥å“åº”: $response"
        if echo "$response" | grep -q '"status":"ok"'; then
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
        # æµ‹è¯•ç™»å½•é¡µé¢
        echo "ğŸ” æµ‹è¯•ç™»å½•é¡µé¢..."
        if curl -f -s http://localhost:8080/login > /dev/null; then
          echo "âœ… ç™»å½•é¡µé¢è®¿é—®æ­£å¸¸"
        else
          echo "âŒ ç™»å½•é¡µé¢è®¿é—®å¤±è´¥"
          exit 1
        fi
        
        # æµ‹è¯•ç”¨æˆ·ç™»å½•
        echo "ğŸ‘¤ æµ‹è¯•ç”¨æˆ·ç™»å½•..."
        login_response=$(curl -s -c cookies.txt -X POST \
          -d "username=admin&password=admin123" \
          http://localhost:8080/login)
        
        if echo "$login_response" | grep -q '"success":true'; then
          echo "âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ"
        else
          echo "âŒ ç”¨æˆ·ç™»å½•å¤±è´¥: $login_response"
          exit 1
        fi
        
        # æµ‹è¯•APIå®šä¹‰åˆ›å»º
        echo "ğŸ“ æµ‹è¯•APIå®šä¹‰åˆ›å»º..."
        create_response=$(curl -s -b cookies.txt -X POST \
          -d "name=Dockeræµ‹è¯•API&description=Dockerç¯å¢ƒæµ‹è¯•&endpoint_path=/docker/test&action_type=shell&action_content=echo 'Docker test success'&parameters={}&enable_logging=true" \
          http://localhost:8080/api/definitions)
        
        if echo "$create_response" | grep -q '"success":true'; then
          echo "âœ… APIå®šä¹‰åˆ›å»ºæˆåŠŸ"
          api_key=$(echo "$create_response" | grep -o '"api_key":"[^"]*"' | cut -d'"' -f4)
          echo "API Key: ${api_key:0:10}..."
        else
          echo "âŒ APIå®šä¹‰åˆ›å»ºå¤±è´¥: $create_response"
          exit 1
        fi
        
        # æµ‹è¯•APIæ‰§è¡Œ
        echo "ğŸš€ æµ‹è¯•APIæ‰§è¡Œ..."
        exec_response=$(curl -s "http://localhost:8080/execute?key=$api_key")
        
        if echo "$exec_response" | grep -q '"success":true' && echo "$exec_response" | grep -q "Docker test success"; then
          echo "âœ… APIæ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ APIæ‰§è¡Œå¤±è´¥: $exec_response"
          exit 1
        fi
        
        echo "ğŸ‰ Dockeréƒ¨ç½²æµ‹è¯•å®Œæˆ - æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼"

    - name: ğŸ“‹ æŸ¥çœ‹å®¹å™¨æ—¥å¿—
      if: always()
      run: |
        echo "ğŸ“‹ APIå®¹å™¨æ—¥å¿—:"
        docker logs api-management-test || true
        echo "ğŸ“‹ PostgreSQLå®¹å™¨æ—¥å¿—:"
        docker logs postgres-test || true

    - name: ğŸ§¹ æ¸…ç†å®¹å™¨
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æµ‹è¯•å®¹å™¨..."
        docker stop api-management-test postgres-test || true
        docker rm api-management-test postgres-test || true

  deploy-summary:
    name: éƒ¨ç½²æ€»ç»“
    runs-on: ubuntu-latest
    needs: [test, docker-test]
    if: always()

    steps:
    - name: ğŸ“Š éƒ¨ç½²æ€»ç»“
      run: |
        echo "ğŸ¯ APIç®¡ç†ç³»ç»Ÿæµ‹è¯•ç»“æœæ€»ç»“"
        echo "================================"
        echo "ğŸ§ª åŠŸèƒ½æµ‹è¯•: ${{ needs.test.result }}"
        echo "ğŸ³ Dockeræµ‹è¯•: ${{ needs.docker-test.result }}"
        echo ""
        
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.docker-test.result }}" == "success" ]; then
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿå¯ä»¥æ­£å¸¸éƒ¨ç½²ã€‚"
          echo "âœ… åŠŸèƒ½å®Œæ•´æ€§éªŒè¯é€šè¿‡"
          echo "âœ… DockeråŒ–éƒ¨ç½²éªŒè¯é€šè¿‡"
          echo "âœ… æ•°æ®åº“è¿æ¥éªŒè¯é€šè¿‡"
          echo "âœ… APIæ‰§è¡ŒéªŒè¯é€šè¿‡"
        else
          echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°è¾“å‡ºã€‚"
          exit 1
        fi 